#!/usr/bin/env ruby

def capture
  begin
    Dir["./#{site}/*.csv"].each do |file|
      logger.info "正在打开 #{keyword} 图片页面."

      list = CSV.read(file).each do |csv_array|
        sku = csv_array[0]
        picture_url = csv_array[3]
        name = csv_array[1]

        picture_csv_filename = "./#{site}/#{keyword}/#{sku}/pictures.csv"

        if test 's', picture_csv_filename
          puts "跳过 #{name} !"
          next
        end

        begin
          logger.info "创建 #{picture_csv_filename}"
          picture_csv_file = CSV.open(picture_csv_filename, "wb")
          browser.reset!
          logger.info "打开 #{picture_url}"
          browser.goto picture_url

          browser.ul(class: 'list-h').lis.each.with_index do |li, i|
            li.click
            logger.info "导入第 #{i+1} 张图片 URL."
            picture_csv_file << [sku, browser.div(id: 'biger').img.src]
          end
        ensure
          logger.info '正在关闭 csv 文件.'
          picture_csv_file.close
        end
      end
    end
  ensure
    logger.info '正在关闭浏览器'
    browser.close unless @browser.nil?
  end
end

unless ARGV.empty?
  puts "无需提供参数, 请先使用 \033[0;33m./get_jd_list #{ARGV.join(' ')}\033[0m 生成抓取列表."
  exit 1
end

require_relative 'common'
include Common

Dir["./#{site}/*.csv"].each do |file|
  self.keyword = File.basename(file, '.csv')
  capture
end
